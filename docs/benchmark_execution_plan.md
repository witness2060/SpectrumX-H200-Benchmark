# SpectrumX H200 8ノードクラスタ ベンチマーク実行計画

## 1. 実行環境概要

### ハードウェア構成
- **クラスタ名**: Fukushima DC HGX Cluster
- **ノード数**: 8ノード (fukushimadc-02-hgx-0001 〜 0009)
- **GPU**: NVIDIA H200 SXM 141GB HBM3e × 8/ノード
- **ノード間接続**: NVIDIA Spectrum-X 400GbE × 2ポート (RoCEv2)
- **ノード内接続**: NVLink 5.0 / NVSwitch
- **ストレージ**: ローカルRAID (NFS不使用)

### ソフトウェア構成
- **OS**: Ubuntu 22.04 LTS
- **CUDA**: 12.5
- **Driver**: 560.xx
- **PyTorch**: 2.3.0
- **DeepSpeed**: 0.14.0
- **NCCL**: 2.26.2 (Sharp対応)

## 2. ベンチマーク実行スケジュール

### Phase 1: 環境準備とバリデーション（Day 1 AM）
1. **09:00-10:00**: セットアップ確認
   - 依存関係のインストール確認
   - NCCL設定の最適化
   - GPU-CPUアフィニティ設定

2. **10:00-11:00**: 通信性能テスト
   - NCCL AllReduce性能測定
   - ノード間レイテンシ測定
   - 帯域幅測定（期待値: 920 Gbps/ノード）

### Phase 2: 2ノードベンチマーク（Day 1 PM）
3. **13:00-15:00**: Llama-2-7B
   - バッチサイズ最適化: 16, 32, 64/GPU
   - 勾配累積ステップ: 4, 8, 16
   - 目標: GPU利用率 > 95%

### Phase 3: 4ノードベンチマーク（Day 2 AM）
4. **09:00-11:00**: Llama-2-7B
   - スケーリング効率測定
   - 通信オーバーヘッド分析

5. **11:00-13:00**: Llama-2-13B
   - メモリ使用率最適化
   - ZeRO Stage 3設定調整

### Phase 4: 8ノードベンチマーク（Day 2 PM）
6. **14:00-16:00**: Llama-2-7B/13B
   - フルスケール性能測定
   - 弱スケーリング/強スケーリング分析

7. **16:00-18:00**: Llama-2-70B
   - 大規模モデル実行可能性検証
   - メモリ最適化（勾配チェックポイント）

### Phase 5: 結果分析とレポート作成（Day 3）
8. **09:00-12:00**: データ分析
   - メトリクス集計
   - スケーリング効率計算
   - ボトルネック分析

9. **13:00-17:00**: レポート作成
   - 技術レポート
   - 営業資料
   - ベストプラクティスガイド

## 3. メトリクス収集項目

### パフォーマンスメトリクス
- **スループット**: samples/sec, tokens/sec
- **レイテンシ**: step時間、iteration時間
- **GPU利用率**: 平均、最小、最大
- **メモリ使用量**: GPU HBM使用率
- **通信性能**: AllReduce時間、帯域幅利用率

### スケーラビリティメトリクス
- **弱スケーリング効率**: (N nodes throughput) / (1 node throughput × N)
- **強スケーリング効率**: 固定バッチサイズでの速度向上
- **通信/計算比**: 通信時間 vs 計算時間

### システムメトリクス
- **電力消費**: GPU電力、システム全体電力
- **温度**: GPU温度、メモリ温度
- **ネットワーク**: パケットロス、再送率

## 4. 最適化パラメータ

### DeepSpeed設定
```json
{
  "zero_optimization": {
    "stage": 3,
    "overlap_comm": true,
    "contiguous_gradients": true,
    "reduce_bucket_size": 1e8,
    "stage3_max_live_parameters": 1e9,
    "stage3_max_reuse_distance": 1e9
  }
}
```

### NCCL環境変数
```bash
export NCCL_IB_HCA=mlx5_0,mlx5_1
export NCCL_IB_GID_INDEX=3
export NCCL_IB_TC=106
export NCCL_IB_QPS_PER_CONNECTION=4
export NCCL_BUFFSIZE=8388608
export NCCL_P2P_LEVEL=NVL
```

### バッチサイズ設定（モデル別）
| モデル | GPU当たりバッチサイズ | 勾配累積 | 有効バッチサイズ |
|--------|---------------------|----------|-----------------|
| 7B     | 16-32               | 8        | 1024-2048       |
| 13B    | 8-16                | 16       | 1024-2048       |
| 70B    | 2-4                 | 32       | 512-1024        |

## 5. 期待される結果

### パフォーマンス目標
- **GPU利用率**: 
  - 2ノード: > 95%
  - 4ノード: > 93%
  - 8ノード: > 90%

- **スケーリング効率**:
  - 2ノード: > 98%
  - 4ノード: > 95%
  - 8ノード: > 90%

- **通信帯域利用率**: > 80% (理論値比)

### 予想スループット
| モデル | 2ノード | 4ノード | 8ノード |
|--------|---------|---------|---------|
| 7B     | 8000    | 15000   | 28000   |
| 13B    | 4000    | 7500    | 14000   |
| 70B    | 800     | 1500    | 2800    |
※ samples/sec

## 6. リスク管理

### 潜在的な問題と対策
1. **OOMエラー**
   - 対策: バッチサイズの段階的削減
   - 勾配チェックポイントの有効化

2. **通信タイムアウト**
   - 対策: NCCLタイムアウト値の増加
   - ネットワークバッファサイズの調整

3. **スケーリング効率低下**
   - 対策: 通信パターンの最適化
   - AllReduceアルゴリズムの選択

## 7. 成果物

### 技術文書
1. ベンチマーク詳細レポート
2. パフォーマンス分析レポート
3. 最適化ガイドライン

### 営業資料
1. エグゼクティブサマリー（1ページ）
2. パフォーマンス比較表
3. ROI分析
4. 導入事例シナリオ

### 実装資産
1. 最適化済み設定ファイル
2. 自動化スクリプト
3. モニタリングダッシュボード設定