# SpectrumX H200 SFTベンチマーク プロジェクト状況報告書

## 作成日時: 2025-08-04

## 📊 プロジェクト概要

このプロジェクトは、福島データセンターに設置されたNVIDIA H200 SXM GPUを搭載した8ノードクラスタにおいて、大規模言語モデル（LLM）のSupervised Fine-Tuning（SFT）ベンチマークを実行するための完全自動化システムです。

## 🎯 最終目的

**目的**: SpectrumX 400GbE接続されたH200×8ノード（合計64 GPU）環境において：
1. **Llama 7B/13B/70B**モデルのSFTベンチマーク実行
2. **GPU利用率90%以上**、**スケール効率95%以上**の達成
3. **営業資料用のパフォーマンスレポート**自動生成
4. **2/4/8ノード構成**での比較ベンチマーク実施

## 🔧 現在の環境構成

### ハードウェア構成
- **総ノード数**: 8ノード（物理的にnode008は存在せず、node009を使用）
- **総GPU数**: 64基（H200 SXM × 8 × 8ノード）
- **総GPUメモリ**: 9.6TB（150GB HBM3e × 64）
- **ノード間接続**: SpectrumX 400GbE × 2（RoCEv2）

### ノード詳細
| ホスト名 | IPアドレス | 役割 | GPU | 状態 |
|---------|-----------|------|-----|------|
| fukushimadc-02-hgx-0001 | 10.2.201.1 | マスター | H200×8 | ✅ 正常 |
| fukushimadc-02-hgx-0002 | 10.2.201.2 | 計算 | H200×8 | ✅ 正常 |
| fukushimadc-02-hgx-0003 | 10.2.201.3 | 計算 | H200×8 | ✅ 正常 |
| fukushimadc-02-hgx-0004 | 10.2.201.4 | 計算 | H200×8 | ✅ 正常 |
| fukushimadc-02-hgx-0005 | 10.2.201.5 | 計算 | H200×8 | ✅ 正常 |
| fukushimadc-02-hgx-0006 | 10.2.201.6 | 計算 | H200×8 | ✅ 正常 |
| fukushimadc-02-hgx-0007 | 10.2.201.7 | 計算 | H200×8 | ⚠️ 性能50% |
| fukushimadc-02-hgx-0009 | 10.2.201.9 | 計算 | H200×8 | ✅ 正常 |

**注**: fukushimadc-02-hgx-0008（10.2.201.8）は物理的に存在しません

### ソフトウェア環境
- **OS**: Ubuntu 22.04 LTS
- **CUDA**: 12.1
- **PyTorch**: 2.3.0/2.5.1（ノードにより異なる）
- **DeepSpeed**: 0.14.0
- **Transformers**: 4.41.0
- **NCCL**: 2.21.5

## ✅ 実施済みタスク

### 1. 環境検証（完了）
- ✅ 全8ノードへのSSH接続確認
- ✅ 全ノードでのGPU認識確認（各ノード8GPU）
- ✅ PyTorch/CUDAの動作確認
- ✅ ホスト名の復元（fukushimadc-02-hgx-XXXX形式）

### 2. 基本動作テスト（完了）
- ✅ LSTMモデルでの学習テスト（平均2225 samples/sec）
- ✅ GPT-2 Smallモデルでの学習テスト（平均148 samples/sec）
- ✅ 全ノードでの個別実行確認
- ⚠️ node007のみ約50%の性能（要調査）

### 3. プロジェクト構造（整備済み）
```
spectrumx-h200-benchmark/
├── setup/          # セットアップスクリプト群
├── configs/        # DeepSpeed設定ファイル
├── scripts/        # ベンチマークスクリプト
├── datasets/       # データセット準備
├── results/        # 実行結果
└── docs/          # ドキュメント
```

## 🚀 実行可能な機能

### 1. 基本的なSFTベンチマーク
```bash
# 2ノードでのベンチマーク
./scripts/run_benchmark.sh meta-llama/Llama-2-7b-hf 2

# 4ノードでのベンチマーク
./scripts/run_benchmark.sh meta-llama/Llama-2-7b-hf 4

# 8ノードでのベンチマーク
./scripts/run_benchmark.sh meta-llama/Llama-2-7b-hf 8
```

### 2. 営業資料用完全自動ベンチマーク
```bash
# 全モデル×全ノード構成での自動実行
./scripts/spectrum_x_benchmark.sh
```

### 3. 本番環境でのSFT訓練
```bash
python scripts/production_sft_benchmark.py \
    --model meta-llama/Llama-2-7b-hf \
    --nodes 8 \
    --dataset alpaca
```

## ⚠️ 既知の問題点

### 1. ノード名の不整合
- **問題**: 一部スクリプトで旧ノード名（node001-009）を使用
- **影響**: 実行時にホスト名解決エラーの可能性
- **対策**: 全スクリプトをfukushimadc-02-hgx-XXXXに統一中

### 2. node007の性能問題
- **症状**: 他ノードの約50%の性能
- **可能性**: 
  - 熱制限/パワー制限
  - PCIe/NVLink設定の問題
  - ハードウェア不具合
- **対策**: nvidia-smi詳細診断が必要

### 3. スクリプトの重複
- **問題**: scripts/に22個の類似スクリプト存在
- **影響**: メンテナンス性の低下
- **対策**: 主要3スクリプトへの統合を推奨

## 📈 期待される性能

### 単一ノード（8GPU）性能推定
| モデル | バッチサイズ | スループット | GPUメモリ |
|--------|-------------|-------------|----------|
| Llama-7B | 16 | 1,280 samples/sec | 60GB |
| Llama-13B | 8 | 640 samples/sec | 100GB |
| Llama-70B | 2 | 160 samples/sec | 140GB |

### スケーリング効率（目標値）
| ノード数 | GPU数 | 期待効率 | 実効スループット倍率 |
|---------|-------|---------|-------------------|
| 1 | 8 | 100% | 1.0x |
| 2 | 16 | 95% | 1.9x |
| 4 | 32 | 90% | 3.6x |
| 8 | 64 | 80% | 6.4x |

## 🔄 次のステップ

### 優先度：高
1. **全スクリプトのホスト名統一**
   - 旧: node001-009
   - 新: fukushimadc-02-hgx-XXXX

2. **node007の性能問題調査**
   ```bash
   ssh fukushimadc-02-hgx-0007 nvidia-smi -q
   ```

3. **NCCLベンチマークテスト**
   ```bash
   ./setup/verify_cluster.sh
   ```

### 優先度：中
1. **大規模モデルでのテスト実行**
   - Llama-7B with LoRA
   - Llama-13B with QLoRA

2. **営業資料の自動生成確認**
   ```bash
   ./scripts/spectrum_x_benchmark.sh --report-only
   ```

## 💡 推奨事項

1. **即座に実行可能**
   - 小規模（2ノード）でのテストは今すぐ実行可能
   - GPT-2レベルのモデルは全ノードで安定動作確認済み

2. **実行前の確認事項**
   - Hugging Faceトークンの設定
   - データセットのダウンロード容量（約100GB）
   - 実行時間の見積もり（フルベンチマーク約24時間）

3. **最適化の余地**
   - Flash Attention 2の有効化
   - NCCL環境変数の最適化
   - GPU-CPU affinityの調整

## 📞 サポート情報

- **プロジェクト場所**: `/root/test/spectrumx-h200-benchmark/`
- **主要設定ファイル**: `.pdshrc_real`
- **ログ保存場所**: `results/`
- **ドキュメント**: `docs/`

## 結論

**プロジェクトの準備状態: 85%完了**

現在のシステムは、ホスト名の不整合を修正すれば、**即座にSFTベンチマークを実行可能**な状態です。全8ノード（64 GPU）での基本的な動作確認は完了しており、小～中規模のモデルでのベンチマークは今すぐ開始できます。

node007の性能問題を解決し、全スクリプトのホスト名を統一すれば、完全な本番環境として運用可能です。